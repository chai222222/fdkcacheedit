{"version":3,"sources":["../../src/usecases/EditAll.js"],"names":["EditAll","editors","length","Error","console","log","map","e","description","join","targetPath","arr","_path2Json","Array","isArray","res","_editAll","dir","path","dirname","base","basename","npath","_json2Path","process","env","FDKCACHEEDIT_OUTPUTORG","orgPath","idSet","Set","String","info","id","filter","has","zaicos","zaico","idx","isTarget","title","nZaico","reduce","z","editOne","_cloneDeepJsonObj","_equalsDeep","undefined","v","obj","JSON","parse","stringify","o1","o2","json","fs","writeFileSync","existsSync","readFileSync"],"mappings":"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","file":"EditAll.js","sourcesContent":["import fs from 'fs';\nimport path from 'path';\n\nexport default class EditAll {\n\n  constructor(editors) {\n    this.editors = editors;\n    if (!editors.length) {\n      throw new Error('コマンドが指定されていません');\n    }\n  }\n\n  description() {\n    console.log(this.editors.map(e => e.description()).join('\\n'));\n  }\n\n  edit(targetPath) {\n    const arr = this._path2Json(targetPath);\n    if (!Array.isArray(arr)) throw new Error(`ファイル ${targetPath} が配列形式になっていません。`);\n    const res = this._editAll(arr);\n    if (res && res.length) {\n      const dir = path.dirname(targetPath);\n      const base = path.basename(targetPath);\n      const npath = path.join(dir, 'edited_' + base);\n      this._json2Path(npath, res);\n      if (process.env.FDKCACHEEDIT_OUTPUTORG) {\n        const orgPath = path.join(dir, 'org_' + base);\n        const idSet = new Set(res.map(info => String(info.id)));\n        this._json2Path(orgPath, arr.filter(info => idSet.has(String(info.id))));\n      }\n    } else {\n      console.log('編集したデータはありませんでした');\n    }\n  }\n\n  _editAll(zaicos) {\n    return zaicos.map((zaico, idx) => {\n      const editors = this.editors.filter(e => e.isTarget(zaico));\n      if (editors.length) {\n        console.log(`[${idx+1}/${zaicos.length}] ${zaico.title}`);\n        const nZaico = editors.reduce((z, e) => e.editOne(z), this._cloneDeepJsonObj(zaico));\n        if (!this._equalsDeep(zaico, nZaico)) return nZaico;\n      }\n      return undefined;\n    }).filter(v => v);\n  }\n\n  _cloneDeepJsonObj(obj) {\n    return JSON.parse(JSON.stringify(obj));\n  }\n\n  _equalsDeep(o1, o2) {\n    return JSON.stringify(o1) === JSON.stringify(o2);\n  }\n\n  _json2path(targetPath, json) {\n    fs.writeFileSync(targetPath, JSON.stringify(json, null, 2));\n  }\n\n  _path2Json(targetPath) {\n    if (!fs.existsSync(targetPath)) {\n      throw new Error(`ファイル ${targetPath} が存在しません。パスを確認してください。`);\n    }\n    try {\n      console.log(`read... ${targetPath}`);\n      return JSON.parse(fs.readFileSync(targetPath, 'utf-8'));\n    } catch (e) {\n      throw new Error(`ファイル ${targetPath} の JSON 読み込みに失敗しました ${e}`);\n    }\n  }\n\n  _json2Path(targetPath, json) {\n    try {\n      console.log(`write... ${targetPath}`);\n      return fs.writeFileSync(targetPath, JSON.stringify(json, null, 2));\n    } catch (e) {\n      throw new Error(`ファイル ${targetPath} の JSON 書き込みに失敗しました ${e}`);\n    }\n  }\n\n}\n"]}